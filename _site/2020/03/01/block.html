<!DOCTYPE html>
<html lang="en-us">

  <head>
  <link href="https://gmpg.org/xfn/11" rel="profile" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta http-equiv="content-type" content="text/html; charset=utf-8" />

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1" />

  <title>
    
      Blocks &middot; Cynine
    
  </title>

  


  <!-- CSS -->
  <link rel="stylesheet" href="/hydeout/assets/css/main.css" />
  

<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Abril+Fatface" />

  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/hydeout/favicon.png" />
<link rel="shortcut icon" href="/hydeout/favicon.ico" />

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/hydeout/feed.xml" />

  <!-- Additional head bits without overriding original head -->
</head>


  <body class="post">

    <div id="sidebar">
  <header>
    <div class="site-title">
      <a href="/hydeout/">
        
          <span class="back-arrow icon"><svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
  <path d="M0 0h24v24H0z" fill="none"/>
  <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/>
</svg></span>
        
        Cynine
      </a>
    </div>
    <p class="lead">Everything I do now, is in pursuit of more perfect.</p>
  </header>
  <nav id="sidebar-nav-links">
  
    <a class="home-link "
        href="/hydeout/">Home</a>
  
  

  

  


  
    
  

  
    
  

  
    
  

  
    
  

  
    
      <a class="page-link "
          href="/hydeout/about">About</a>
    
  

  
    
  

  
    
  

  

  
    
  

  
    
  

  

  
    
  


  


  
    
  

  
    
      <a class="category-link "
          href="/hydeout/category/Developer">å¼€å‘ç¬”è®°</a>
    
  

  
    
      <a class="category-link "
          href="/hydeout/category/Flutter">Flutter</a>
    
  

  
    
      <a class="category-link "
          href="/hydeout/category/Python">Python</a>
    
  

  
    
  

  
    
      <a class="category-link "
          href="/hydeout/category/iOS">iOS</a>
    
  

  
    
  

  

  
    
  

  
    
  

  

  
    
  


  <!-- Optional additional links to insert in sidebar nav -->
</nav>


  

  <nav id="sidebar-icon-links">
  
    <a id="github-link"
       class="icon" title="Github Project" aria-label="Github Project"
       href="https://github.com/Cynine/hydeout">
      <svg version="1.1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 28" height="24" width="28"><path d="M12 2c6.625 0 12 5.375 12 12 0 5.297-3.437 9.797-8.203 11.391-0.609 0.109-0.828-0.266-0.828-0.578 0-0.391 0.016-1.687 0.016-3.297 0-1.125-0.375-1.844-0.812-2.219 2.672-0.297 5.484-1.313 5.484-5.922 0-1.313-0.469-2.375-1.234-3.219 0.125-0.313 0.531-1.531-0.125-3.187-1-0.313-3.297 1.234-3.297 1.234-0.953-0.266-1.984-0.406-3-0.406s-2.047 0.141-3 0.406c0 0-2.297-1.547-3.297-1.234-0.656 1.656-0.25 2.875-0.125 3.187-0.766 0.844-1.234 1.906-1.234 3.219 0 4.594 2.797 5.625 5.469 5.922-0.344 0.313-0.656 0.844-0.766 1.609-0.688 0.313-2.438 0.844-3.484-1-0.656-1.141-1.844-1.234-1.844-1.234-1.172-0.016-0.078 0.734-0.078 0.734 0.781 0.359 1.328 1.75 1.328 1.75 0.703 2.141 4.047 1.422 4.047 1.422 0 1 0.016 1.937 0.016 2.234 0 0.313-0.219 0.688-0.828 0.578-4.766-1.594-8.203-6.094-8.203-11.391 0-6.625 5.375-12 12-12zM4.547 19.234c0.031-0.063-0.016-0.141-0.109-0.187-0.094-0.031-0.172-0.016-0.203 0.031-0.031 0.063 0.016 0.141 0.109 0.187 0.078 0.047 0.172 0.031 0.203-0.031zM5.031 19.766c0.063-0.047 0.047-0.156-0.031-0.25-0.078-0.078-0.187-0.109-0.25-0.047-0.063 0.047-0.047 0.156 0.031 0.25 0.078 0.078 0.187 0.109 0.25 0.047zM5.5 20.469c0.078-0.063 0.078-0.187 0-0.297-0.063-0.109-0.187-0.156-0.266-0.094-0.078 0.047-0.078 0.172 0 0.281s0.203 0.156 0.266 0.109zM6.156 21.125c0.063-0.063 0.031-0.203-0.063-0.297-0.109-0.109-0.25-0.125-0.313-0.047-0.078 0.063-0.047 0.203 0.063 0.297 0.109 0.109 0.25 0.125 0.313 0.047zM7.047 21.516c0.031-0.094-0.063-0.203-0.203-0.25-0.125-0.031-0.266 0.016-0.297 0.109s0.063 0.203 0.203 0.234c0.125 0.047 0.266 0 0.297-0.094zM8.031 21.594c0-0.109-0.125-0.187-0.266-0.172-0.141 0-0.25 0.078-0.25 0.172 0 0.109 0.109 0.187 0.266 0.172 0.141 0 0.25-0.078 0.25-0.172zM8.937 21.438c-0.016-0.094-0.141-0.156-0.281-0.141-0.141 0.031-0.234 0.125-0.219 0.234 0.016 0.094 0.141 0.156 0.281 0.125s0.234-0.125 0.219-0.219z"></path>
</svg>

    </a>
    <a id="github-download-link"
       class="icon" title="Download" aria-label="Download"
       href="https://github.com/Cynine/hydeout/archive/v4.0.2.zip">
      <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/>
    <path d="M0 0h24v24H0z" fill="none"/>
</svg>
    </a>
  

  <a id="subscribe-link"
     class="icon" title="Subscribe" aria-label="Subscribe"
     href="/hydeout/feed.xml">
    <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h24v24H0z" fill="none"/>
    <circle cx="6.18" cy="17.82" r="2.18"/>
    <path d="M4 4.44v2.83c7.03 0 12.73 5.7 12.73 12.73h2.83c0-8.59-6.97-15.56-15.56-15.56zm0 5.66v2.83c3.9 0 7.07 3.17 7.07 7.07h2.83c0-5.47-4.43-9.9-9.9-9.9z"/>
</svg>
  </a>

  
  
  
  

  
    <a id="tags-link"
       class="icon"
       title="Tags" aria-label="Tags"
       href="/hydeout/tags">
      <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h24v24H0z" fill="none"/>
    <path d="M17.63 5.84C17.27 5.33 16.67 5 16 5L5 5.01C3.9 5.01 3 5.9 3 7v10c0 1.1.9 1.99 2 1.99L16 19c.67 0 1.27-.33 1.63-.84L22 12l-4.37-6.16z"/>
</svg>
    </a>
  

  
    <a id="search-link"
       class="icon"
       title="Search" aria-label="Search"
       href="/hydeout/search">
      <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
    <path d="M0 0h24v24H0z" fill="none"/>
</svg>
    </a>
  

  <!-- Optional additional links to insert for icons links -->
</nav>

  <p>
  &copy; 2020.
  <a href="/hydeout/LICENSE.md">MIT License.</a>
</p>

</div>

    <main class="container">
      <header>
  <h1 class="post-title">Blocks</h1>
</header>
<div class="content">
  <div class="post-meta">
  <span class="post-date">01 Mar 2020</span>
  <span class="post-categories">
    
      &bull;

      
      
      

      
        <a href="/hydeout/category/iOS">
          iOS
        </a>
      
    
  </span>
</div>


  <div class="post-body">
    <h2 id="blocks-çŸ¥è¯†ç‚¹">Blocks çŸ¥è¯†ç‚¹</h2>
<p><img src="/assets/images/15835447426404.jpg" alt="img" /></p>

<h2 id="å‰è¨€">å‰è¨€</h2>
<ul>
  <li>blockçš„åŸç†æ˜¯æ€æ ·çš„ï¼Ÿæœ¬è´¨æ˜¯ä»€ä¹ˆï¼Ÿ</li>
  <li>__blockçš„ä½œç”¨æ˜¯ä»€ä¹ˆï¼Ÿæœ‰ä»€ä¹ˆä½¿ç”¨æ³¨æ„ç‚¹ï¼Ÿ</li>
  <li>blockçš„å±æ€§ä¿®é¥°è¯ä¸ºä»€ä¹ˆæ˜¯copyï¼Ÿä½¿ç”¨blockæœ‰å“ªäº›ä½¿ç”¨æ³¨æ„ï¼Ÿ</li>
  <li>blockåœ¨ä¿®æ”¹NSMutableArrayï¼Œéœ€ä¸éœ€è¦æ·»åŠ __blockï¼Ÿ</li>
</ul>

<h2 id="1-blocks-æ¦‚è¦">1. Blocks æ¦‚è¦</h2>
<h3 id="11-ä»€ä¹ˆæ˜¯-blocks">1.1 ä»€ä¹ˆæ˜¯ Blocks</h3>

<p>Blocks æ˜¯ C è¯­è¨€çš„æ‰©å……åŠŸèƒ½ï¼Œå³ï¼š<strong>å¸¦æœ‰è‡ªåŠ¨å˜é‡ï¼ˆå±€éƒ¨å˜é‡ï¼‰çš„åŒ¿åå‡½æ•°</strong>ã€‚</p>
<ul>
  <li>â€œå¸¦æœ‰è‡ªåŠ¨å˜é‡â€ï¼šä¸ºä¿è¯ Blocks èƒ½æ­£å¸¸è®¿é—®å¤–éƒ¨çš„å˜é‡ï¼ŒBlocks æœ‰ä¸€ä¸ªè‡ªåŠ¨æ•è·å˜é‡çš„æœºåˆ¶ã€‚Blocks èƒ½è‡ªåŠ¨æ•è·ï¼ˆä¿å­˜ï¼‰åœ¨å…¶å†…éƒ¨ä½¿ç”¨åˆ°çš„å¤–éƒ¨è‡ªåŠ¨å˜é‡ï¼ˆå±€éƒ¨å˜é‡ï¼‰çš„<strong>ç¬é—´å€¼</strong>ã€‚</li>
  <li>åŒ¿åå‡½æ•°:ä¸å¸¦æœ‰åç§°çš„å‡½æ•°ã€‚</li>
</ul>

<p>å…¶ä»–è¯­è¨€ä¸­ Block çš„åç§°</p>

<table>
  <thead>
    <tr>
      <th style="text-align: center">ç¨‹åºè¯­è¨€</th>
      <th style="text-align: center">Block çš„åç§°</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: center">C + Blocks</td>
      <td style="text-align: center">Block</td>
    </tr>
    <tr>
      <td style="text-align: center">Smalltalk</td>
      <td style="text-align: center">Block</td>
    </tr>
    <tr>
      <td style="text-align: center">Ruby</td>
      <td style="text-align: center">Block</td>
    </tr>
    <tr>
      <td style="text-align: center">LISP</td>
      <td style="text-align: center">Block</td>
    </tr>
    <tr>
      <td style="text-align: center">Python</td>
      <td style="text-align: center">Lambda</td>
    </tr>
    <tr>
      <td style="text-align: center">C++ 11</td>
      <td style="text-align: center">Lambda</td>
    </tr>
    <tr>
      <td style="text-align: center">JavaScript</td>
      <td style="text-align: center">Anonymous fucntion</td>
    </tr>
  </tbody>
</table>

<h2 id="2-block-æ¨¡å¼">2. Block æ¨¡å¼</h2>
<h3 id="21-block-è¯­æ³•">2.1 Block è¯­æ³•</h3>
<p>å®Œæ•´å½¢å¼çš„ Block è¯­æ³•ä¸ä¸€èˆ¬çš„ C è¯­è¨€å‡½æ•°å®šä¹‰ç›¸æ¯”ï¼Œä»…æœ‰ä¸¤ç‚¹ä¸åŒï¼š</p>
<ol>
  <li>æ²¡æœ‰å‡½æ•°å: å› ä¸º Block æ˜¯åŒ¿åå‡½æ•°ã€‚</li>
  <li>å¸¦æœ‰â€œ\^â€ ï¼ˆæ’å…¥è®°å·ï¼Œcaretï¼‰è®°å·: å› ä¸º OS Xã€iOS åº”ç”¨ç¨‹åºçš„æºä»£ç ä¸­å°†å¤§é‡ä½¿ç”¨ Blockï¼Œæ‰€ä»¥æ’å…¥è¯¥è®°å¥½ä¾¿äºæŸ¥æ‰¾ã€‚</li>
</ol>

<p>Block å£°æ˜è¯­æ³•:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>^ è¿”å›å€¼ç±»å‹ å‚æ•°åˆ—è¡¨ è¡¨è¾¾å¼

e.g:
^int (int count) { return count + 1; };
</code></pre></div></div>
<p>Block è¯­æ³•çš„ç®€åŒ–ï¼š</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1. çœç•¥è¿”å›å€¼ç±»å‹ï¼ˆè¡¨è¾¾å¼å«æœ‰ return è¯­å¥æ—¶ï¼Œå…¶è¿”å›å€¼ç±»å‹å¿…å®šä¸ return è¿”å›å€¼çš„ç±»å‹ä¸€è‡´ï¼‰

^ å‚æ•°åˆ—è¡¨ è¡¨è¾¾å¼

e.g:
^(int count) { return count + 1; };

2. çœç•¥è¿”å›å€¼ç±»å‹å’Œå‚æ•°åˆ—è¡¨

^è¡¨è¾¾å¼

e.g:
^{ return count + 1 };
</code></pre></div></div>
<h3 id="22-block-ç±»å‹å˜é‡">2.2 Block ç±»å‹å˜é‡</h3>
<p>Block è¯­æ³•ä½†ä»è®°è¿°æ–¹å¼æ¥çœ‹ï¼Œé™¤äº†æ²¡æœ‰åç§°å’Œå¸¦æœ‰â€œ\^â€ä»¥å¤–ï¼Œå…¶ä»–çš„éƒ½ä¸ C è¯­è¨€å‡½æ•°å®šä¹‰ç›¸åŒã€‚åœ¨å®šä¹‰ C è¯­è¨€å‡½æ•°æ—¶ï¼Œå¯ä»¥å°†å®šä¹‰å‡½æ•°çš„åœ°å€èµ‹å€¼ç»™å‡½æ•°æŒ‡é’ˆå˜é‡ä¸­ã€‚</p>

<pre><code class="language-C">int func(int count)
{
    return count + 1;
}
int (*funcptr)(int) = &amp;func;
</code></pre>
<p>åœ¨ Block çš„è¯­æ³•ä¸‹ï¼Œå¯å°† Block è¯­æ³•èµ‹å€¼ç»™å£°æ˜ä¸º Block ç±»å‹çš„å˜é‡ä¸­ã€‚å³æºä»£ç ä¸­ä¸€æ—¦ä½¿ç”¨ Block è¯­æ³•å°±ç›¸å½“äºç”Ÿæˆäº†å¯èµ‹å€¼ç»™ Block ç±»å‹å˜é‡çš„â€œå€¼â€ã€‚åœ¨ Blocks ä¸­ï¼Œâ€œBlockâ€ æ—¢æŒ‡æºä»£ç ä¸­çš„ Block è¯­æ³•ï¼Œä¹ŸæŒ‡ç”± Block è¯­æ³•æ‰€ç”Ÿæˆçš„å€¼ã€‚
å£°æ˜ Block ç±»å‹å˜é‡ï¼š</p>

<pre><code class="language-C">int (^blk)(int);
</code></pre>
<p>ä¸å‰é¢å¯¹æ¯”ä½¿ç”¨å‡½æ•°æŒ‡é’ˆçš„æºä»£ç å¯¹æ¯”ï¼Œå£°æ˜ Block ç±»å‹å˜é‡ä»…ä»…æ˜¯å°†å£°æ˜å‡½æ•°æŒ‡é’ˆç±»å‹å˜é‡çš„ â€œ*â€ å˜æˆäº† â€œ\^â€ã€‚è¯¥ Block ç±»å‹å˜é‡çš„ä¸ä¸€èˆ¬çš„ C è¯­è¨€å˜é‡å®Œæˆç›¸åŒï¼Œå¯åšä¸ºä»¥ä¸‹ç”¨é€”ä½¿ç”¨:</p>
<ul>
  <li>è‡ªåŠ¨å˜é‡</li>
  <li>å‡½æ•°å‚æ•°</li>
  <li>é™æ€å˜é‡</li>
  <li>é™æ€å…¨å±€å˜é‡</li>
  <li>å…¨å±€å˜é‡
ä½¿ç”¨ Block è¯­æ³•å°† Block èµ‹å€¼ä¸º Block ç±»å‹å˜é‡:</li>
</ul>

<pre><code class="language-C">int (^blk)(int) = ^(int count) { return count + 1; };
</code></pre>
<ul>
  <li>ç”± Block ç±»å‹å˜é‡å‘ Block ç±»å‹å˜é‡èµ‹å€¼ï¼š</li>
</ul>

<pre><code class="language-C">int (^blk1)(int) = blk;

int (^blk2)(int);
blk2 = blk1;
</code></pre>
<ul>
  <li>å°† Block ç±»å‹å˜é‡ä½œä¸ºå‡½æ•°å‚æ•°ä½¿ç”¨ï¼š</li>
</ul>

<pre><code class="language-C">void func(int (^blk)(int) {}
</code></pre>
<ul>
  <li>å°† Block ä½œä¸ºå‡½æ•°çš„è¿”å›å€¼è¿”å›ï¼š</li>
</ul>

<pre><code class="language-C">int (^func())(int)
{
    return ^(int count){return count + 1;};
}
</code></pre>
<ul>
  <li>ä½¿ç”¨ <code class="highlighter-rouge">typedef</code> ç®€åŒ–ä¸Šè¿°æ“ä½œï¼š</li>
</ul>

<pre><code class="language-C">typedef int (^blk_t)(int);

/* åŸæ¥çš„è®°è¿°æ–¹å¼ 
void func(int (^blk)(int))
*/
ç®€åŒ–ä¸ºï¼š
void func(blk_t blk) {}

/* åŸæ¥çš„è®°è¿°æ–¹å¼
int (^func()(int))
*/
ç®€åŒ–ä¸ºï¼š
blk_t func()
</code></pre>
<p>å°†èµ‹å€¼ç»™ Block ç±»å‹å˜é‡ä¸­çš„ Block æ–¹æ³•çš„è°ƒç”¨ä¸ä½¿ç”¨å‡½æ•°æŒ‡é’ˆç±»å‹å˜é‡è°ƒç”¨å‡½æ•°çš„æ–¹æ³•å‡ ä¹å®Œå…¨ç›¸åŒï¼š</p>
<ul>
  <li>è°ƒç”¨å‡½æ•°æŒ‡é’ˆç±»å‹å˜é‡:</li>
</ul>

<pre><code class="language-C">int result = (*funcptr)(10);
</code></pre>
<ul>
  <li>è°ƒç”¨ Block ç±»å‹å˜é‡:</li>
</ul>

<pre><code class="language-C">int result = blk(10);
</code></pre>
<p>Block ç±»å‹å˜é‡è°ƒç”¨ Block ä¸ C è¯­è¨€é€šå¸¸çš„å‡½æ•°è°ƒç”¨æ²¡æœ‰åŒºåˆ«ã€‚åœ¨å‡½æ•°å‚æ•°é‡ä½¿ç”¨ Block ç±»å‹å˜é‡å¹¶åœ¨å‡½æ•°ä¸­æ‰§è¡Œ Block çš„ä¾‹å­:</p>

<pre><code class="language-C">int func(blk_t blk, int rate)
{
    return blk(rete);
}
</code></pre>
<p>åœ¨ Objective-C ä¸­æ–¹æ³•ä½¿ç”¨:</p>

<pre><code class="language-Objective-c">- (int)methodUsingBlock:(blk_t)blk rete:(int)rete
{
    return blk(rete);
}
</code></pre>
<p>Block ç±»å‹å˜é‡å¯å®Œå…¨åƒé€šå¸¸çš„ C è¯­è¨€å˜é‡ä¸€æ ·ä½¿ç”¨ï¼Œå› æ­¤ä¹Ÿå¯ä»¥ä½¿ç”¨ä¹‹ä¹¡ Block ç±»å‹å˜é‡çš„æŒ‡é’ˆï¼Œå³ Block çš„æŒ‡é’ˆç±»å‹å˜é‡:</p>

<pre><code class="language-C">typedef int (^blk_t)(int);

blk_t blk = ^(int count){return count + 1; };

blk_t *blkprt = &amp;blk;

(*blkptr)(10);
</code></pre>
<h3 id="23-æˆªè·è‡ªåŠ¨å˜é‡å€¼">2.3 æˆªè·è‡ªåŠ¨å˜é‡å€¼</h3>
<p>â€œå¸¦æœ‰è‡ªåŠ¨å˜é‡å€¼â€åœ¨ Blocks ä¸­è¡¨ç°ä¸ºâ€œæˆªè·è‡ªåŠ¨å˜é‡å€¼â€ã€‚æˆªè·è‡ªåŠ¨å˜é‡å€¼çš„å®ä¾‹å¦‚ä¸‹:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> 
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">dmy</span> <span class="o">=</span> <span class="mi">256</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">val</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fmt</span> <span class="o">=</span> <span class="s">"val = %d</span><span class="se">\n</span><span class="s">"</span><span class="p">;</span>
    <span class="kt">void</span> <span class="p">(</span><span class="o">^</span><span class="n">blk</span><span class="p">)(</span><span class="kt">void</span><span class="p">)</span> <span class="o">=</span> <span class="o">^</span><span class="p">{</span><span class="n">printf</span><span class="p">(</span><span class="n">fmt</span><span class="p">,</span> <span class="n">val</span><span class="p">);};</span>
    
    <span class="n">val</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
    <span class="n">fmt</span> <span class="o">=</span> <span class="s">"Thes values were changed. val = %d</span><span class="se">\n</span><span class="s">"</span><span class="p">;</span>
    
    <span class="n">bll</span><span class="p">();</span>
    
    <span class="k">return</span> <span class="mi">0</span>
<span class="p">}</span>

<span class="c1">// val = 10</span>
</code></pre></div></div>
<p>åœ¨è¯¥ä»£ç ä¸­ï¼Œ Block è¯­æ³•çš„è¡¨è¾¾å¼ä½¿ç”¨çš„æ˜¯å®ƒä¹‹å‰å£°æ˜çš„è‡ªåŠ¨å˜é‡ fmt å’Œ valã€‚Blocks ä¸­ï¼ŒBlock è¡¨è¾¾å¼æˆªè·æ‰€ä½¿ç”¨çš„è‡ªåŠ¨å˜é‡å€¼ï¼Œå³ä¿å­˜è¯¥è‡ªåŠ¨å˜é‡çš„<strong>ç¬é—´å€¼</strong>ã€‚åœ¨æ‰§è¡Œ Block è¯­æ³•åï¼Œå³ä½¿æ”¹å†™ Block ä¸­ä½¿ç”¨çš„è‡ªåŠ¨å˜é‡çš„å€¼ä¹Ÿä¸ä¼šå½±å“ Block æ‰§è¡Œæ—¶å˜é‡çš„å€¼ã€‚è¯¥ Block è¯­æ³•æ‰§è¡Œæ—¶ï¼Œå­—ç¬¦ä¸²æŒ‡é’ˆ â€œval=%d\nâ€è¢«èµ‹å€¼åˆ°è‡ªåŠ¨å˜é‡ fmt ä¸­ï¼Œint å€¼ 10 è¢«èµ‹å€¼åˆ°è‡ªåŠ¨å˜é‡ val ä¸­ï¼Œå› æ­¤è¿™äº›å€¼è¢«ä¿å­˜ï¼ˆå³è¢«æˆªè·ï¼‰ï¼Œä»è€Œåœ¨æ‰§è¡Œå—æ—¶ä½¿ç”¨ã€‚<strong>è¿™å°±æ˜¯è‡ªåŠ¨å˜é‡å€¼çš„æ•è·</strong>ã€‚</p>

<h3 id="24-__block-è¯´æ˜ç¬¦">2.4 __block è¯´æ˜ç¬¦</h3>
<p>è‹¥æƒ³åœ¨ Block è¯­æ³•çš„è¡¨è¾¾å¼ä¸­å°†èµ‹ç»™ Block è¯­æ³•å¤–å£°æ˜çš„è‡ªåŠ¨å˜é‡ï¼Œéœ€è¦åœ¨è¯¥è‡ªåŠ¨å˜é‡ä¸Šé™„åŠ  <code class="highlighter-rouge">__block</code> è¯´æ˜ç¬¦ã€‚</p>

<pre><code class="language-C">__block int val = 0;

void (^blk)(void) = ^{ val = 1; };

blk();

printf("val = %d\n", val);

// val = 1
</code></pre>
<p>ä½¿ç”¨é™„æœ‰ <code class="highlighter-rouge">__block</code> è¯´æ˜ç¬¦çš„è‡ªåŠ¨å˜é‡å¯åœ¨ Block ä¸­èµ‹å€¼ï¼Œ<strong>è¯¥å˜é‡ç§°ä¸º __block å˜é‡</strong>ã€‚</p>
<h2 id="3-blocks-çš„å®ç°">3 Blocks çš„å®ç°</h2>
<h3 id="31-block-çš„å®è´¨">3.1 Block çš„å®è´¨</h3>
<p>é€šè¿‡ clangï¼ˆLLVM ç¼–è¯‘å™¨ï¼‰å°† Objective-C æºä»£ç è½¬æ¢ä¸º C++ çš„æºä»£ç ï¼š</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>clang -rewrite-objc æºä»£ç æ–‡ä»¶å
</code></pre></div></div>

<pre><code class="language-C">int main(int argc, const char *argv[])
{
    void (^ blk)(void) = ^{ printf("Block\n"); };

    blk();

    return 0;
}
</code></pre>
<p>é€šè¿‡ clang å°†ä¸Šè¿°ä»£ç è½¬æ¢æˆ C++ ä»£ç å¾—ï¼š</p>

<pre><code class="language-C">struct __block_impl {
  void *isa;
  int Flags;
  int Reserved;
  void *FuncPtr;
};

struct __main_block_impl_0 {
  struct __block_impl impl;
  struct __main_block_desc_0* Desc;
  __main_block_impl_0(void *fp, struct __main_block_desc_0 *desc, int flags=0) {
    impl.isa = &amp;_NSConcreteStackBlock;
    impl.Flags = flags;
    impl.FuncPtr = fp;
    Desc = desc;
  }
};

static void __main_block_func_0(struct __main_block_impl_0 *__cself) 
{
    printf("Block\n"); 
}

static struct __main_block_desc_0 {
  size_t reserved;
  size_t Block_size;
} __main_block_desc_0_DATA = { 
    0, 
    sizeof(struct __main_block_impl_0)
};

int main(int argc, const char *argv[])
{
    void (* blk)(void) = ((void (*)())&amp;__main_block_impl_0((void *)__main_block_func_0, &amp;__main_block_desc_0_DATA));

    ((void (*)(__block_impl *))((__block_impl *)blk)-&gt;FuncPtr)((__block_impl *)blk);

    return 0;
}
</code></pre>

<p>å¯¹æ¯”æœ€åˆçš„æºä»£ç ä¸­çš„ Block è¯­æ³•ï¼š</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">^</span><span class="p">{</span><span class="n">printf</span><span class="p">(</span><span class="s">"Block</span><span class="se">\n</span><span class="s">"</span><span class="p">)};</span>
</code></pre></div></div>

<p>è½¬æ¢ä¸ºï¼š</p>

<pre><code class="language-C">static void __main_block_func_0(struct __main_block_impl_0 *__cself) 
{
    printf("Block\n"); 
}
</code></pre>

<p>å¦‚è½¬æ¢çš„æºä»£ç æ‰€ç¤ºï¼Œé€šè¿‡ Blocks ä½¿ç”¨çš„åŒ¿åå‡½æ•°å®é™…ä¸Šè¢«ä½œä¸ºç®€å•çš„ C è¯­è¨€å‡½æ•°æ¥å¤„ç†ã€‚å¦å¤–ï¼Œæ ¹æ® Block è¯­æ³•æ‰€å±çš„å‡½æ•°åï¼ˆæ­¤å¤„ä¸ºmainï¼‰å’Œè¯¥ Block è¯­æ³•åœ¨è¯¥å‡½æ•°å‡ºç°çš„é¡ºåºå€¼ï¼ˆæ­¤å¤„ä¸º0ï¼‰æ¥ç» clang å˜æ¢çš„å‡½æ•°å‘½åã€‚</p>

<p><code class="highlighter-rouge">__cself</code> ç›¸å½“äº C++ å®ä¾‹æ–¹æ³•ä¸­æŒ‡å‘å®ä¾‹è‡ªèº«çš„å˜é‡ <code class="highlighter-rouge">this</code>ï¼Œæˆ–æ˜¯ Objective-C å®ä¾‹æ–¹æ³•ä¸­æŒ‡å‘å¯¹è±¡è‡ªèº«çš„å˜é‡ <code class="highlighter-rouge">self</code>, å³å‚æ•° <code class="highlighter-rouge">__cself</code> ä¸ºæŒ‡å‘ Block å€¼çš„å˜é‡ã€‚<code class="highlighter-rouge">__cself</code> å£°æ˜å¦‚ä¸‹ï¼š</p>

<pre><code class="language-C">struct __main_block_impl_0 *__cself
</code></pre>

<p>ä¸ C++ çš„ this å’Œ Objective-C çš„ self ç›¸åŒï¼Œ å‚æ•° __cself æ˜¯ __main_block_impl_0 ç»“æ„é¢˜çš„æŒ‡é’ˆã€‚è¯¥ç»“æ„ä½“å£°æ˜å¦‚ä¸‹ï¼š</p>

<pre><code class="language-C">struct __main_block_impl_0 {
  struct __block_impl impl; // ä»Šåç‰ˆæœ¬å‡çº§æ‰€éœ€çš„åŒºåŸŸä»¥åŠå‡½æ•°æŒ‡é’ˆ
  struct __main_block_desc_0* Desc; // å…¶ç»“æ„ä¸ºä»Šåç‰ˆæœ¬å‡çº§æ‰€éœ€è¦åŒºåŸŸå’Œ Block çš„å¤§å°
};	
</code></pre>

<p><strong>__block_impl</strong> ç»“æ„ä½“çš„å£°æ˜ï¼š</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">struct</span> <span class="n">__block_impl</span> <span class="p">{</span>
  <span class="kt">void</span> <span class="o">*</span><span class="n">isa</span><span class="p">;</span> 
  <span class="kt">int</span> <span class="n">Flags</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">Reserved</span><span class="p">;</span>
  <span class="kt">void</span> <span class="o">*</span><span class="n">FuncPtr</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div></div>

<p><strong>__main_block_desc_0</strong> ç»“æ„ä½“å£°æ˜ï¼š</p>

<pre><code class="language-C">static struct __main_block_desc_0 {
  size_t reserved;
  size_t Block_size;
}
</code></pre>

<p>å†çœ‹ <strong>__main_block_impl_0</strong> ç»“æ„çš„æ„é€ å‡½æ•°ï¼š</p>

<pre><code class="language-C">__main_block_impl_0(void *fp, struct __main_block_desc_0 *desc, int flags=0) {
    impl.isa = &amp;_NSConcreteStackBlock; 
    impl.Flags = flags;
    impl.FuncPtr = fp;
    Desc = desc;
}
</code></pre>

<p>è¯¥æ„é€ å‡½æ•°çš„è°ƒç”¨ï¼š</p>

<pre><code class="language-C">void (* blk)(void) = 
  ((void (*)())&amp;__main_block_impl_0(
     (void *)__main_block_func_0, &amp;__main_block_desc_0_DATA));
</code></pre>

<p>å»æ‰å¼ºåˆ¶è½¬åŒ–éƒ¨åˆ†ï¼Œå¯å¾—ï¼š</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">struct</span> <span class="n">__mian_block_impl_0</span> <span class="n">tmp</span> <span class="o">=</span> <span class="n">__main_block_impl_0</span><span class="p">(</span>
     <span class="n">__main_block_func_0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">__main_block_desc_0_DATA</span><span class="p">);</span>

<span class="k">struct</span> <span class="n">__main_block_impl_0</span> <span class="o">*</span><span class="n">blk</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tmp</span><span class="p">;</span>
</code></pre></div></div>

<p>è¯¥ä»£ç å°† <code class="highlighter-rouge">__main_block_impl_0</code> ç»“æ„ä½“ç±»å‹çš„è‡ªåŠ¨å˜é‡ï¼Œå³æ ˆä¸Šç”Ÿæˆçš„ <code class="highlighter-rouge">__main_block_impl_0</code> ç»“æ„ä½“å®ä¾‹çš„æŒ‡é’ˆï¼Œèµ‹å€¼ç»™ <code class="highlighter-rouge">__main_block_impl_0</code> ç»“æ„ä½“æŒ‡é’ˆç±»å‹çš„å˜é‡ <code class="highlighter-rouge">blk</code>ã€‚è¿™éƒ¨åˆ†æœ€åˆçš„æºä»£ç ä¸ºï¼š</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="p">(</span><span class="o">^</span> <span class="n">blk</span><span class="p">)(</span><span class="kt">void</span><span class="p">)</span> <span class="o">=</span> <span class="o">^</span><span class="p">{</span> <span class="n">printf</span><span class="p">(</span><span class="s">"Block</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span> <span class="p">};</span>	
</code></pre></div></div>

<p>å°† Block è¯­æ³•ç”Ÿæˆçš„ Block èµ‹å€¼ç»™ Block ç±»å‹çš„å˜é‡ blkã€‚ç­‰åŒäºå°† <code class="highlighter-rouge">__main_block_impl_0</code>  ç»“æ„ä½“å®ä¾‹çš„æŒ‡é’ˆèµ‹å€¼ç»™ <code class="highlighter-rouge">blk</code>ã€‚è¯¥æºä»£ç ä¸­çš„ Block å°±æ˜¯ <code class="highlighter-rouge">__main_block_impl_0</code> ç»“æ„ä½“ç±»å‹çš„è‡ªåŠ¨å˜é‡ï¼Œå³æ ˆä¸Šç”Ÿæˆçš„ <code class="highlighter-rouge">__main_block_impl_0</code> ç»“æ„ä½“å®ä¾‹ã€‚</p>

<p>ç”± <code class="highlighter-rouge">__main_block_impl_0</code> ç»“æ„ä½“æºä»£ç å¯å¾—ï¼Œè¯¥ç»“æ„ä½“çš„æ„é€ å‡½æ•°çš„æ„é€ å‚æ•°ä¸ºï¼š</p>

<pre><code class="language-C">__main_block_impl_0(__main_block_func_0, &amp;__main_block_desc_0_DATA);
</code></pre>

<p>ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ç”± Block è¯­æ³•è½¬æ¢çš„ C è¯­è¨€å‡½æ•°æŒ‡é’ˆã€‚ç¬¬äºŒä¸ªå‚æ•°æ˜¯ä½œä¸ºé™æ€å…¨å±€å˜é‡åˆå§‹åŒ–çš„ <code class="highlighter-rouge">__main_block_desc_0</code> ç»“æ„ä½“å®ä¾‹æŒ‡é’ˆã€‚ä»¥ä¸‹æ˜¯ <code class="highlighter-rouge">__main_block_desc_0</code>  ç»“æ„ä½“å®ä¾‹çš„åˆå§‹åŒ–éƒ¨åˆ†ä»£ç ï¼š</p>

<pre><code class="language-C">static struct __main_block_desc_0  __main_block_desc_0_DATA = { 
    0, 
    sizeof(struct __main_block_impl_0)
}
</code></pre>

<p>ç”±æ­¤å¯çŸ¥ï¼Œè¯¥æºä»£ç ä½¿ç”¨ Blockï¼Œ å³ <code class="highlighter-rouge">__main_block_impl_0</code> ç»“æ„ä½“çš„å®ä¾‹çš„å¤§å°ï¼Œè¿›è¡Œåˆå§‹åŒ–ã€‚</p>

<p>æ ˆä¸Š <code class="highlighter-rouge">__main_block_impl_0</code> ç»“æ„ä½“å®ä¾‹ï¼ˆå³ Blockï¼‰å‚æ•°çš„åˆå§‹åŒ–è¿‡ç¨‹ï¼š</p>

<pre><code class="language-C">// å±•å¼€ __main_block_impl_0 ç»“æ„ä½“çš„ __block_impl ç»“æ„ä½“
struct __main_block_impl_0 {
  void *isa; 
  int Flags;
  int Reserved;
  void *FuncPtr;
  struct __main_block_desc_0* Desc; 
};	
</code></pre>

<p>è¯¥æ„é€ ä½“æ ¹æ®æ„é€ å‡½æ•°ä¼šåƒä¸‹é¢è¿™æ ·è¿›è¡Œåˆå§‹åŒ–ï¼š</p>

<pre><code class="language-C">isa = &amp;_NSConcreteStackBlock; 
Flags = 0;
Reserved = 0;
FuncPtr = __main_block_func_0;
Desc = &amp;__main_block_desc_0_DATA;
</code></pre>

<p>å†çœ‹ Block è°ƒç”¨éƒ¨åˆ†æºä»£ç ï¼š</p>

<pre><code class="language-C">blk();
</code></pre>

<p>è¿™éƒ¨åˆ†å¯è½¬æ¢ä¸ºä»¥ä¸‹æºä»£ç ï¼š</p>

<pre><code class="language-C">((void (*)(__block_impl *))((__block_impl *)blk)-&gt;FuncPtr)((__block_impl *)blk);
</code></pre>

<p>å»æ‰è½¬æ¢éƒ¨åˆ†ï¼š</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>(*blk-&gt;impl.FuncPtr)(blk);
</code></pre></div></div>

<p>è¿™å°±æ˜¯ç®€å•åœ°ä½¿ç”¨å‡½æ•°æŒ‡é’ˆè°ƒç”¨å‡½æ•°ã€‚ç”± Block è¯­æ³•è½¬æ¢çš„ <code class="highlighter-rouge">__main_block_func_0</code> å‡½æ•°çš„æŒ‡é’ˆè¢«èµ‹å€¼ç»™æˆå‘˜å˜é‡ FuncPtr ä¸­ã€‚å¦å¤–è¯´æ˜äº†ï¼Œ<code class="highlighter-rouge">__main_block_func_0</code> å‡½æ•°çš„å‚æ•° <code class="highlighter-rouge">__cself</code> æŒ‡å‘ Block å€¼ã€‚åœ¨è°ƒç”¨è¯¥å‡½æ•°çš„æºä»£ç ä¸­å¯ä»¥çœ‹å‡º Block æ­£å¼ä½œä¸ºå‚æ•°è¿›è¡Œäº†ä¼ é€’ã€‚</p>

<p>è‡³æ­¤æ€»ç®—æ˜¯æ‘¸æ¸…äº† Block çš„å®è´¨ï¼Œä¸è¿‡ä¹‹å‰è·³è¿‡æ²¡æœ‰è¯´æ˜çš„ <code class="highlighter-rouge">_NSConcreteStackBlock</code> åˆ°åº•æ˜¯ä»€ä¹ˆã€‚</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>isa = &amp;_NSConcreteStackBlock; 
</code></pre></div></div>

<p>å°† Block æŒ‡é’ˆèµ‹ç»™ Block çš„ç»“æ„ä½“æˆå‘˜å˜é‡ isaã€‚ä¸ºäº†ç†è§£å®ƒï¼Œé¦–å…ˆè¦ç†è§£ Objective-C ç±»å’Œå¯¹è±¡çš„å®è´¨ã€‚å…¶å®ï¼Œ<strong>æ‰€è°“ Block å°±æ˜¯ Objective-C å¯¹è±¡</strong>ã€‚</p>

<h3 id="32-æˆªè·è‡ªåŠ¨å˜é‡å€¼">3.2 æˆªè·è‡ªåŠ¨å˜é‡å€¼</h3>

<pre><code class="language-objective-c">int main(int argc, const char * argv[]) {
    @autoreleasepool {
        
        int dmy = 256;
        int val = 10;
        const char *fmt = "val = %d\n";
        
        void (^blk)(void) = ^{printf(fmt, val);};
        
        blk();
        
    }
    return 0;
}
</code></pre>

<p>é€šè¿‡ clang è½¬æ¢å¯å¾—ï¼š</p>

<pre><code class="language-C">struct __main_block_impl_0 {
  struct __block_impl impl;
  struct __main_block_desc_0* Desc;
  const char *fmt;
  int val;
  
  __main_block_impl_0(void *fp, struct __main_block_desc_0 *desc, const char *_fmt, int _val, int flags=0) : fmt(_fmt), val(_val) {
    impl.isa = &amp;_NSConcreteStackBlock;
    impl.Flags = flags;
    impl.FuncPtr = fp;
    Desc = desc;
  }
};

static void __main_block_func_0(struct __main_block_impl_0 *__cself) {
  const char *fmt = __cself-&gt;fmt; // bound by copy
  int val = __cself-&gt;val; // bound by copy
printf(fmt, val);}

static struct __main_block_desc_0 {
  size_t reserved;
  size_t Block_size;
} __main_block_desc_0_DATA = { 0, sizeof(struct __main_block_impl_0)};
int main(int argc, const char * argv[]) {
    /* @autoreleasepool */ { __AtAutoreleasePool __autoreleasepool; 

        int dmy = 256;
        int val = 10;
        const char *fmt = "val = %d\n";

        void (*blk)(void) = ((void (*)())&amp;__main_block_impl_0((void *)__main_block_func_0, &amp;__main_block_desc_0_DATA, fmt, val));

        ((void (*)(__block_impl *))((__block_impl *)blk)-&gt;FuncPtr)((__block_impl *)blk);

    }
    return 0;
}
</code></pre>

<p>Block è¯­æ³•è¡¨è¾¾å¼ä¸­ä½¿ç”¨çš„è‡ªåŠ¨å˜é‡è¢«ä½œä¸ºæˆå‘˜å˜é‡è¿½åŠ åˆ°äº† <code class="highlighter-rouge">__main_block_impl_0</code>ç»“æ„ä½“ä¸­ã€‚</p>

<pre><code class="language-C">struct __main_block_impl_0 {
  struct __block_impl impl;
  struct __main_block_desc_0* Desc;
  const char *fmt;
  int val;
};
</code></pre>

<p><code class="highlighter-rouge">__main_block_impl_0</code> ç»“æ„ä½“å†…å£°æ˜çš„æˆå‘˜å˜é‡ç±»å‹ä¸è‡ªåŠ¨å˜é‡ç±»å‹å®Œå…¨ç›¸åŒï¼ˆåªæœ‰åœ¨ Block è¯­æ³•è¡¨è¾¾å¼ä¸­ä½¿ç”¨çš„è‡ªåŠ¨å˜é‡æ‰ä¼šè¢«è¿½åŠ ï¼‰ã€‚<strong>Block çš„è‡ªåŠ¨å˜é‡æ•è·åªé’ˆå¯¹ Block ä½¿ç”¨çš„è‡ªåŠ¨å˜é‡</strong>ã€‚</p>

<pre><code class="language-C">__main_block_impl_0(void *fp, struct __main_block_desc_0 *desc, const char *_fmt, int _val, int flags=0) : fmt(_fmt), val(_val) { }
</code></pre>

<p>åœ¨åˆå§‹åŒ–ç»“æ„ä½“æ—¶ï¼Œæ ¹æ®ä¼ é€’ç»™æ„é€ å‡½æ•°çš„å‚æ•°å¯¹è‡ªåŠ¨å˜é‡è¿½åŠ çš„æˆå‘˜å˜é‡è¿›è¡Œåˆå§‹åŒ–ã€‚ä»¥ä¸‹é€šè¿‡æ„é€ å‡½æ•°è°ƒç”¨ç¡®è®¤å…¶å‚æ•°ï¼š</p>

<pre><code class="language-C">void (*blk)(void) = 
  ((void (*)())&amp;__main_block_impl_0((void *)__main_block_func_0, &amp;__main_block_desc_0_DATA, fmt, val));
</code></pre>

<p>ä½¿ç”¨æ‰§è¡Œ Block è¯­æ³•æ—¶çš„è‡ªåŠ¨å˜é‡ fmt å’Œ val æ¥åˆå§‹åŒ– <code class="highlighter-rouge">__main_block_impl_0</code> ç»“æ„ä½“å®ä¾‹ã€‚å³åœ¨è¯¥æºä»£ç ä¸­ï¼Œ<code class="highlighter-rouge">__main_block_impl_0</code> ç»“æ„ä½“å®ä¾‹çš„åˆå§‹åŒ–å¦‚ä¸‹ï¼š</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>impl.isa = &amp;_NSConcreteStackBlock;
impl.Flags = 0;
impl.FuncPtr = __main_block_func_0;
Desc = &amp;__main_block_desc_0_DATA;
fmt = "val = %d\n";
val = 10;
</code></pre></div></div>

<p>ç”±æ­¤å¯çŸ¥ï¼Œåœ¨ <code class="highlighter-rouge">__main_block_impl_0</code> ç»“æ„ä½“å®ä¾‹ï¼ˆå³Blockï¼‰ ä¸­ï¼Œè‡ªåŠ¨å˜é‡å€¼è¢«æ•è·ã€‚</p>

<p>ä¸‹é¢å†çœ‹ä¸€ä¸‹ä½¿ç”¨ Block çš„åŒ¿åå‡½æ•°çš„å®ç°ã€‚æœ€åˆæºä»£ç çš„ Block è¯­æ³•å¦‚ä¸‹æ‰€ç¤ºï¼š</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">^</span><span class="p">{</span><span class="n">printf</span><span class="p">(</span><span class="n">fmt</span><span class="p">,</span> <span class="n">val</span><span class="p">);}</span>
</code></pre></div></div>

<p>è¯¥æºä»£ç å¯è½¬æ¢ä»¥ä¸‹å‡½æ•°ï¼š</p>

<pre><code class="language-C">static void __main_block_func_0(struct __main_block_impl_0 *__cself) {
  const char *fmt = __cself-&gt;fmt; // bound by copy
  int val = __cself-&gt;val; // bound by copy
	printf(fmt, val);
}
</code></pre>

<p>åœ¨è½¬æ¢åçš„æºä»£ç ä¸­ï¼Œæˆªè·åˆ° <code class="highlighter-rouge">__main_block_impl_0</code> ç»“æ„ä½“å®ä¾‹çš„æˆå‘˜å˜é‡ä¸Šçš„è‡ªåŠ¨å˜é‡ï¼Œè¿™äº›å˜é‡åœ¨ Block è¯­æ³•è¡¨è¾¾å¼ä¹‹å‰è¢«å£°æ˜å®šä¹‰ã€‚å› æ­¤ï¼ŒåŸæ¥çš„æºä»£ç è¡¨è¾¾å¼æ— éœ€æ”¹åŠ¨ä¾¿å¯ä½¿ç”¨æˆªè·çš„è‡ªåŠ¨å˜é‡å€¼æ‰§è¡Œã€‚</p>

<p>æ€»çš„æ¥è¯´ï¼Œæ‰€è°“â€œæˆªè·è‡ªåŠ¨å˜é‡å€¼â€æ„å‘³ç€åœ¨æ‰§è¡Œ Block è¯­æ³•æ—¶ï¼ŒBlock è¯­æ³•è¡¨è¾¾å¼æ‰€ä½¿ç”¨çš„è‡ªåŠ¨å˜é‡å€¼è¢«ä¿å­˜åˆ° Block çš„ç»“æ„ä½“å®ä¾‹ï¼ˆå³Blockè‡ªèº«ï¼‰ä¸­ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒBlock ä¸èƒ½ç›´æ¥ä½¿ç”¨ C è¯­è¨€æ•°ç»„ç±»å‹çš„è‡ªåŠ¨å˜é‡ã€‚</p>

<h3 id="33-__block-è¯´æ˜ç¬¦">3.3 __block è¯´æ˜ç¬¦</h3>

<p>Block ä¸­æ‰€ä½¿ç”¨çš„è¢«æˆªè·è‡ªåŠ¨å˜é‡å°±å¦‚â€œå¸¦æœ‰è‡ªåŠ¨å˜é‡å€¼çš„åŒ¿åå‡½æ•°â€æ‰€è¯´ï¼Œä»…æˆªè·è‡ªåŠ¨å˜é‡çš„å€¼ã€‚Block ä¸­ä½¿ç”¨è‡ªåŠ¨å˜é‡åï¼Œåœ¨ Block çš„ç»“æ„ä½“å®ä¾‹ä¸­é‡å†™è¯¥è‡ªåŠ¨å˜é‡ä¹Ÿä¸ä¼šæ”¹å˜åŸå…ˆæˆªè·çš„è‡ªåŠ¨å˜é‡ã€‚</p>

<p>åœ¨ C è¯­è¨€ä¸­æœ‰ä¸ªä¸€ä¸ªå˜é‡å…è®¸ Block æ”¹å†™å€¼ï¼š</p>

<ul>
  <li>é™æ€å˜é‡</li>
  <li>é™æ€å…¨å±€å˜é‡</li>
  <li>å…¨å±€å˜é‡</li>
</ul>

<pre><code class="language-objective-c">int global_val = 1;
static int static_global_val = 2;


int main(int argc, const char * argv[]) {
    @autoreleasepool {
        
        static int static_val = 3;
        
        void (^blk)(void) = ^{
            global_val *= 1;
            static_global_val *= 2;
            static_val *= 3;
        };
        
        blk();
        
        printf("global_val=%d\n", global_val);
        printf("static_global_val=%d\n", static_global_val);
        printf("static_val=%d\n", static_val);
        
    }
    return 0;
}
</code></pre>

<p>è¯¥æºä»£ç è½¬æ¢åå¦‚ä¸‹ï¼š</p>

<pre><code class="language-C">int global_val = 1;
static int static_global_val = 2;

struct __main_block_impl_0 {
  struct __block_impl impl;
  struct __main_block_desc_0* Desc;
  int *static_val;
  __main_block_impl_0(void *fp, struct __main_block_desc_0 *desc, int *_static_val, int flags=0) : static_val(_static_val) {
    impl.isa = &amp;_NSConcreteStackBlock;
    impl.Flags = flags;
    impl.FuncPtr = fp;
    Desc = desc;
  }
};
static void __main_block_func_0(struct __main_block_impl_0 *__cself) {
  int *static_val = __cself-&gt;static_val; // bound by copy

            global_val *= 1;
            static_global_val *= 2;
            (*static_val) *= 3;
        }

static struct __main_block_desc_0 {
  size_t reserved;
  size_t Block_size;
} __main_block_desc_0_DATA = { 0, sizeof(struct __main_block_impl_0)};
int main(int argc, const char * argv[]) {
    /* @autoreleasepool */ { __AtAutoreleasePool __autoreleasepool; 

        static int static_val = 3;

        void (*blk)(void) = ((void (*)())&amp;__main_block_impl_0((void *)__main_block_func_0, &amp;__main_block_desc_0_DATA, &amp;static_val));

        ((void (*)(__block_impl *))((__block_impl *)blk)-&gt;FuncPtr)((__block_impl *)blk);

        printf("global_val=%d\n", global_val);
        printf("static_global_val=%d\n", static_global_val);
        printf("static_val=%d\n", static_val);

    }
    return 0;
}
</code></pre>

<p>ç”±æ­¤å¯è§è®¿é—®é™æ€å…¨å±€å˜é‡ <code class="highlighter-rouge">static_global_val</code> å’Œå…¨å±€å˜é‡ <code class="highlighter-rouge">global_val</code> ä¸è½¬æ¢å‰å®Œå…¨ç›¸åŒã€‚</p>

<pre><code class="language-C">static void __main_block_func_0(struct __main_block_impl_0 *__cself) {
  int *static_val = __cself-&gt;static_val; // bound by copy

						...
            (*static_val) *= 3;
        }
</code></pre>

<p>å¯¹äºé™æ€å˜é‡ <code class="highlighter-rouge">static_val</code>, ä½¿ç”¨é™æ€å˜é‡ <code class="highlighter-rouge">static_val</code>çš„æŒ‡é’ˆå¯¹å…¶è¿›è¡Œè®¿é—®ã€‚å°†é™æ€å˜é‡ <code class="highlighter-rouge">static_val</code> çš„<strong>æŒ‡é’ˆ</strong>ä¼ é€’ç»™ <code class="highlighter-rouge">__main_block_impl_0</code>ç»“æ„ä½“çš„æ„é€ å‡½æ•°å¹¶ä¿å­˜ã€‚</p>

<p>é™æ€å˜é‡çš„è¿™ç§æ–¹æ³•ä¼¼ä¹ä¹Ÿé€‚ç”¨äºè‡ªåŠ¨å˜é‡çš„è®¿é—®ã€‚ä½†ä¸ºä»€ä¹ˆæ²¡æœ‰è¿™ä¹ˆåšå‘¢ï¼Ÿ</p>

<p>å®é™…ä¸Šï¼Œåœ¨ç”± Block è¯­æ³•ç”Ÿæˆçš„å€¼ Block ä¸Šï¼Œå¯ä»¥å­˜æœ‰è¶…è¿‡å…¶å˜é‡ä½œç”¨åŸŸçš„è¢«æˆªè·å¯¹è±¡çš„è‡ªåŠ¨å˜é‡ã€‚å˜é‡ä½œç”¨åŸŸç»“æŸçš„åŒæ—¶ï¼ŒåŸæ¥çš„è‡ªåŠ¨å˜é‡è¢«åºŸå¼ƒï¼Œå› æ­¤ Block ä¸­è¶…è¿‡å˜é‡ä½œç”¨äºè€Œå­˜åœ¨çš„å˜é‡åŒé™æ€å˜é‡ä¸€æ ·ï¼Œå°†ä¸èƒ½é€šè¿‡æŒ‡é’ˆè®¿é—®åŸæ¥çš„è‡ªåŠ¨å˜é‡ã€‚</p>

<p>è§£å†³ Block ä¸­ä¸èƒ½ä¿å­˜å€¼è¿™ä¸€é—®é¢˜çš„ç¬¬äºŒç§æ–¹æ³•æ˜¯ä½¿ç”¨ <strong>__block</strong> è¯´æ˜ç¬¦ã€‚åœ¨ C è¯­è¨€ä¸­æœ‰ä»¥ä¸‹å­˜å‚¨åŸŸç±»è¯´æ˜ç¬¦ï¼š</p>

<ul>
  <li>typedef</li>
  <li>extern</li>
  <li>static</li>
  <li>auto</li>
  <li>register</li>
</ul>

<p>__block è¯´æ˜ç¬¦ç±»ä¼¼äº static ã€auto å’Œ register è¯´æ˜ç¬¦ï¼Œå®ƒä»¬ç”¨äºæŒ‡å®šå°†å˜é‡å€¼è®¾ç½®åˆ°å“ªä¸ªå­˜å‚¨åŸŸä¸­ã€‚ä¾‹å¦‚ï¼Œauto è¡¨ç¤ºä½œä¸ºè‡ªåŠ¨å˜é‡å­˜å‚¨åœ¨æ ˆä¸­ï¼Œstatic è¡¨ç¤ºä½œä¸ºé™æ€å˜é‡å­˜å‚¨åœ¨æ•°æ®åŒºä¸­ã€‚</p>

<p>__block ä½¿ç”¨å¦‚ä¸‹ï¼š</p>

<pre><code class="language-objective-c">int main(int argc, const char * argv[]) {
    @autoreleasepool {
        
        __block int val = 10;
        void (^blk)(void) = ^{val = 1;};
        
        blk();
        
        printf("val=%d", val);
        
    }
    return 0;
}
</code></pre>

<p>è½¬æ¢åå¦‚ä¸‹ï¼š</p>

<pre><code class="language-C++">struct __Block_byref_val_0 {
  void *__isa;
__Block_byref_val_0 *__forwarding;
 int __flags;
 int __size;
 int val;
};

struct __main_block_impl_0 {
  struct __block_impl impl;
  struct __main_block_desc_0* Desc;
  __Block_byref_val_0 *val; // by ref
  
  __main_block_impl_0(void *fp, struct __main_block_desc_0 *desc, __Block_byref_val_0 *_val, int flags=0) : val(_val-&gt;__forwarding) {
    impl.isa = &amp;_NSConcreteStackBlock;
    impl.Flags = flags;
    impl.FuncPtr = fp;
    Desc = desc;
  }
};

static void __main_block_func_0(struct __main_block_impl_0 *__cself) {
  __Block_byref_val_0 *val = __cself-&gt;val; // bound by ref
(val-&gt;__forwarding-&gt;val) = 1;}

static void __main_block_copy_0(struct __main_block_impl_0*dst, struct __main_block_impl_0*src) {_Block_object_assign((void*)&amp;dst-&gt;val, (void*)src-&gt;val, 8/*BLOCK_FIELD_IS_BYREF*/);}

static void __main_block_dispose_0(struct __main_block_impl_0*src) {_Block_object_dispose((void*)src-&gt;val, 8/*BLOCK_FIELD_IS_BYREF*/);}

static struct __main_block_desc_0 {
  size_t reserved;
  size_t Block_size;
  void (*copy)(struct __main_block_impl_0*, struct __main_block_impl_0*);
  void (*dispose)(struct __main_block_impl_0*);
} __main_block_desc_0_DATA = { 0, sizeof(struct __main_block_impl_0), __main_block_copy_0, __main_block_dispose_0};

int main(int argc, const char * argv[]) {
    /* @autoreleasepool */ { __AtAutoreleasePool __autoreleasepool; 

        //__attribute__((__blocks__(byref))) __Block_byref_val_0 val = {(void*)0,(__Block_byref_val_0 *)&amp;val, 0, sizeof(__Block_byref_val_0), 10};
        __Block_byref_val_0 val = {
          0,
          &amp;val, 
          0, 
          sizeof(__Block_byref_val_0), 
          10
        };               
                        
        void (*blk)(void) = ((void (*)())&amp;__main_block_impl_0((void *)__main_block_func_0, &amp;__main_block_desc_0_DATA, (__Block_byref_val_0 *)&amp;val, 570425344));

        ((void (*)(__block_impl *))((__block_impl *)blk)-&gt;FuncPtr)((__block_impl *)blk);

        printf("val=%d", (val.__forwarding-&gt;val));

    }
    return 0;
}
</code></pre>

<p>ç”±ä»¥ä¸Šæºç å¯å¾—å˜é‡ val ä¸Šé™„åŠ äº† __block è¯´æ˜ç¬¦ä¹‹åï¼š</p>

<pre><code class="language-C">__block int val = 10;

// ç»è¿‡è½¬æ¢
struct __Block_byref_val_0 val = {
	0,
  &amp;val,
  0,
  sizeof(__Block_byref_val_0),
  10
};
</code></pre>

<p><code class="highlighter-rouge">__block</code> å˜é‡å˜ä¸ºäº†ç»“æ„ä½“å®ä¾‹ã€‚<code class="highlighter-rouge">__block</code> å˜é‡ä¹ŸåŒ Block ä¸€æ ·å˜æˆ <code class="highlighter-rouge">__Block_byref_val_0</code> ç»“æ„ä½“ç±»å‹çš„è‡ªåŠ¨å˜é‡ï¼Œå³æ ˆä¸Šç”Ÿæˆçš„ <code class="highlighter-rouge">__Block_byref_val_0</code> ç»“æ„ä½“å®ä¾‹ã€‚è¯¥å˜é‡åˆå§‹åŒ–ä¸º10ï¼Œä¸”è¿™ä¸ªå€¼ä¹Ÿå‡ºç°åœ¨ç»“æ„ä½“å®ä¾‹çš„åˆå§‹åŒ–ä¸­ï¼Œè¿™æ„å‘³ç€è¯¥ç»“æ„ä½“æŒæœ‰ç›¸å½“äºåŸè‡ªåŠ¨å˜é‡çš„æˆå‘˜å˜é‡ã€‚è¯¥ç»“æ„ä½“å£°æ˜å¦‚ä¸‹ï¼š</p>

<pre><code class="language-C">struct __Block_byref_val_0 {
 void *__isa;
 __Block_byref_val_0 *__forwarding;
 int __flags;
 int __size;
 int val;
};
</code></pre>

<p>å¦‚åŒåˆå§‹åŒ–æ—¶çš„æºä»£ç ï¼Œè¯¥ç»“æ„ä½“ä¸­æœ€åçš„æˆå‘˜å˜é‡ val æ˜¯ç›¸å½“äºåŸè‡ªåŠ¨å˜é‡çš„æˆå‘˜å˜é‡ï¼Œä»å®ƒçš„åç§°ä¹Ÿèƒ½çœ‹å‡ºè¿™ä¸€ç‚¹ã€‚</p>

<p>å†æ¥çœ‹ç»™ __block å˜é‡èµ‹å€¼çš„ä»£ç ï¼š</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>^{val = 1;}
</code></pre></div></div>

<p>è½¬æ¢å¦‚ä¸‹ï¼š</p>

<pre><code class="language-C">static void __main_block_func_0(struct __main_block_impl_0 *__cself) {
  __Block_byref_val_0 *val = __cself-&gt;val; // bound by ref
	(val-&gt;__forwarding-&gt;val) = 1;
}
</code></pre>

<p>åˆšåˆšåœ¨ Block ä¸­å‘é™æ€å˜é‡èµ‹å€¼æ—¶ï¼Œä½¿ç”¨äº†æŒ‡å‘è¯¥é™æ€å˜é‡çš„æŒ‡é’ˆã€‚è€Œå‘ <code class="highlighter-rouge">__block</code> å˜é‡èµ‹å€¼è¿‡ç¨‹ä¸­ï¼ŒBlock çš„<code class="highlighter-rouge">__main_block_impl_0</code> ç»“æ„ä½“å®ä¾‹æŒæœ‰æŒ‡å‘ <code class="highlighter-rouge">__block</code> å˜é‡ val çš„ <code class="highlighter-rouge">__Block_byref_val_0</code> ç»“æ„ä½“å®ä¾‹çš„æŒ‡é’ˆã€‚</p>

<p><code class="highlighter-rouge">__Block_byref_val_0</code> ç»“æ„ä½“å®ä¾‹çš„æˆå‘˜å˜é‡ <code class="highlighter-rouge">__forwarding</code> æŒæœ‰æŒ‡å‘è¯¥å®ä¾‹è‡ªèº«çš„æŒ‡é’ˆã€‚é€šè¿‡æˆå‘˜å˜é‡ <code class="highlighter-rouge">__forwarding</code> è®¿é—®æˆå‘˜å˜é‡ valï¼ˆæˆå‘˜å˜é‡ val æ—¶è¯¥å®ä¾‹è‡ªèº«æŒæœ‰çš„å˜é‡ï¼Œå®ƒç›¸å½“äºåŸè‡ªåŠ¨å˜é‡ï¼‰ã€‚</p>

<p><img src="/assets/images/image-20200307190818557.png" alt="img" /></p>

<p>å¦å¤–, <code class="highlighter-rouge">__block</code> å˜é‡çš„ <code class="highlighter-rouge">__Block_byref_val_0</code> ç»“æ„ä½“å¹¶ä¸åœ¨ Block ä¸­çš„ <code class="highlighter-rouge">__main_block_impl_0</code> ç»“æ„ä½“ä¸­ï¼Œè¿™æ ·åšæ˜¯ä¸ºäº†åœ¨å¤šä¸ª Block ä¸­ä½¿ç”¨ <code class="highlighter-rouge">__Block</code>å˜é‡ã€‚</p>

<pre><code class="language-C">__block int val = 10;
        
void (^blk0)(void) = ^{val = 0;};

void (^blk1)(void) = ^{val = 1;};
</code></pre>

<p>Block ç±»å‹å˜é‡ blk0 å’Œ blk1 è®¿é—® <code class="highlighter-rouge">__block</code> å˜é‡ valã€‚è¿™éƒ¨åˆ†ä»£ç è½¬æ¢åå¦‚ä¸‹ï¼š</p>

<pre><code class="language-C">__Block_byref_val_0 val = {0, &amp;val, 0, sizeof(__Block_byref_val_0), 10};

blk0 = &amp;__main_block_impl_0(
  __main_block_func_0, &amp;__main_block_desc_0_DATA, (__Block_byref_val_0 *)&amp;val, 570425344));

blk1 = &amp;__main_block_impl_1(
  __main_block_func_1, &amp;__main_block_desc_1_DATA, (__Block_byref_val_0 *)&amp;val, 570425344));
</code></pre>

<p>ä¸¤ä¸ª Block éƒ½æ˜¯ç”¨äº† <code class="highlighter-rouge">__Block_byref_val_0</code> ç»“æ„ä½“å®ä¾‹ val çš„æŒ‡é’ˆã€‚è¿™æ ·ä¸€æ¥å°±å¯ä»¥ä»å¤šä¸ª Block ä¸­ä½¿ç”¨åŒä¸€ä¸ª <code class="highlighter-rouge">__block</code> å˜é‡ã€‚å½“ç„¶ï¼Œåè¿‡æ¥ä»ä¸€ä¸ª Block ä¸­ä½¿ç”¨å¤šä¸ª <code class="highlighter-rouge">__block</code> å˜é‡ä¹Ÿæ˜¯å¯ä»¥çš„ã€‚åªè¦å¢åŠ  Block çš„ç»“æ„ä½“æˆå‘˜å˜é‡ä¸æ„é€ å‡½æ•°çš„å‚æ•°ï¼Œä¾¿å¯å¯¹åº”ä½¿ç”¨å¤šä¸ª <code class="highlighter-rouge">__block</code> å˜é‡ã€‚</p>


    



<div class="post-tags">
  
    
    <a href="/hydeout/tags#objective-c">
    
      <span class="icon">
        <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h24v24H0z" fill="none"/>
    <path d="M17.63 5.84C17.27 5.33 16.67 5 16 5L5 5.01C3.9 5.01 3 5.9 3 7v10c0 1.1.9 1.99 2 1.99L16 19c.67 0 1.27-.33 1.63-.84L22 12l-4.37-6.16z"/>
</svg>
      </span>&nbsp;<span class="tag-name">Objective-C</span>
    </a>
  
</div>
  </div>

  
  <section class="comments">
    <h2>Comments</h2>
    
  <div id="disqus_thread">
    <button class="disqus-load" onClick="loadDisqusComments()">
      Load Comments
    </button>
  </div>
  <script>

  /**
  *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW
  *  TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
  *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT:s
  *  https://disqus.com/admin/universalcode/#configuration-variables
  */
  var disqus_config = function () {
    this.page.url = "http://localhost:4000/hydeout/2020/03/01/block.html";
    this.page.identifier = "" ||
                           "http://localhost:4000/hydeout/2020/03/01/block.html";
  }
  function loadDisqusComments() { // DON'T EDIT BELOW THIS LINE
    var d = document, s = d.createElement('script');
    s.src = '//hydeout.disqus.com/embed.js';
    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
  }
  </script>
  <noscript>
    Please enable JavaScript to view the
    <a href="https://disqus.com/?ref_noscript">comments powered by Disqus</a>.
  </noscript>



  </section>

  <section class="related">
  <h2>Related Posts</h2>
  <ul class="posts-list">
    
      <li>
        <h3>
          <a href="/hydeout/2020/01/17/flutter-widget.html">
            Widget çŸ¥è¯†ç‚¹
            <small>17 Jan 2020</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/hydeout/2020/01/14/ios-map.html">
            iOS å¼€å‘èˆ†å›¾
            <small>14 Jan 2020</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/hydeout/2020/01/13/swift-project-open-libs.html">
            ğŸš€ Swift é¡¹ç›®ä¸­çš„å¼€æºåº“
            <small>13 Jan 2020</small>
          </a>
        </h3>
      </li>
    
  </ul>
</section>

</div>

    </main>

    <!-- Optional footer content -->

  </body>
</html>
